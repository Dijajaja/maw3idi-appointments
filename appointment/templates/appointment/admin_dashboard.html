{% extends "base_templates/black_dashboard_base.html" %}
{% load i18n %}
{% load static %}

{% block navbar_title %}{% trans "Dashboard Admin" %}{% endblock %}

{% block customCSS %}
<style>
  /* Design professionnel compact */
  .content-wrapper {
    padding: 40px 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    background: transparent !important;
  }
  
  .row {
    max-width: 1000px;
    width: 100%;
    margin: 0 auto;
  }
  
  /* Statistiques cards améliorées */
  .stats-card {
    background: linear-gradient(135deg, rgba(20, 20, 40, 0.9), rgba(25, 25, 50, 0.85)) !important;
    backdrop-filter: blur(10px) saturate(180%) !important;
    -webkit-backdrop-filter: blur(10px) saturate(180%) !important;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 15px;
    border: none !important;
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: fadeInUp 0.6s ease-out both;
    position: relative;
    overflow: hidden;
  }
  
  .stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.08), 
        transparent);
    transition: left 0.5s;
    pointer-events: none;
    z-index: 1;
  }
  
  .stats-card:hover::before {
    left: 100%;
  }

  .stats-card:nth-child(1) { animation-delay: 0.1s; }
  .stats-card:nth-child(2) { animation-delay: 0.2s; }
  .stats-card:nth-child(3) { animation-delay: 0.3s; }
  .stats-card:nth-child(4) { animation-delay: 0.4s; }
  
  .stats-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 
        0 12px 35px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(160, 70, 255, 0.2);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Animation pour les graphiques */
  .chart-container {
    animation: scaleIn 0.8s ease-out both;
    animation-delay: 0.5s;
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  .stats-card .card-icon {
    font-size: 2.5rem;
    opacity: 0.8;
    margin-bottom: 12px;
    position: relative;
    z-index: 2;
  }
  
  .stats-card .card-title {
    font-size: 0.85rem;
    opacity: 0.7;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 500;
    position: relative;
    z-index: 2;
  }
  
  .stats-card .card-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.2;
    position: relative;
    z-index: 2;
  }
  
  /* Badges améliorés avec couleurs vives */
  .badge {
    padding: 6px 14px;
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 20px;
    letter-spacing: 0.5px;
  }
  
  .badge-success {
    background: linear-gradient(135deg, #4caf50, #66bb6a) !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
  }
  
  .badge-info {
    background: linear-gradient(135deg, #2196f3, #42a5f5) !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
  }
  
  .badge-warning {
    background: linear-gradient(135deg, #ff9800, #ffa726) !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
  }
  
  .badge-secondary {
    background: linear-gradient(135deg, #757575, #9e9e9e) !important;
    color: white !important;
  }
  
  /* Graphique avec message vide */
  .chart-container {
    background: linear-gradient(135deg, rgba(20, 20, 40, 0.9), rgba(25, 25, 50, 0.85)) !important;
    backdrop-filter: blur(10px) saturate(180%) !important;
    -webkit-backdrop-filter: blur(10px) saturate(180%) !important;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 15px;
    border: none !important;
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    position: relative;
    min-height: 280px;
  }
  
  .chart-empty-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    z-index: 1;
  }
  
  .chart-empty-message i {
    font-size: 4rem;
    margin-bottom: 15px;
    opacity: 0.3;
  }
  
  .chart-empty-message p {
    font-size: 1.1rem;
    margin: 0;
  }
  
  /* Card headers avec padding amélioré */
  .card {
    background: linear-gradient(135deg, rgba(10, 10, 25, 0.95), rgba(15, 15, 35, 0.9)) !important;
    backdrop-filter: blur(10px) saturate(180%) !important;
    -webkit-backdrop-filter: blur(10px) saturate(180%) !important;
    border-radius: 12px !important;
    border: none !important;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    margin-bottom: 20px;
  }
  
  .card-header {
    padding: 15px 18px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: transparent !important;
  }
  
  .card-header .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    letter-spacing: 0.5px;
    color: rgba(255, 255, 255, 0.95);
  }
  
  .card-body {
    padding: 18px !important;
    background: transparent !important;
  }
  
  /* Services populaires améliorés */
  .popular-services-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .popular-services-list li {
    padding: 14px 16px;
    margin-bottom: 10px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
  }
  
  .popular-services-list li:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(5px);
    border-left-color: #ffa726;
  }
  
  .service-name {
    font-weight: 600;
    font-size: 0.9rem;
    flex: 1;
  }
  
  .service-count {
    background: linear-gradient(135deg, #ffa726, #fb8c00);
    color: white;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.85rem;
    box-shadow: 0 4px 15px rgba(255, 167, 38, 0.3);
    min-width: 45px;
    text-align: center;
  }
  
  .service-bar {
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    margin-top: 8px;
    overflow: hidden;
  }
  
  .service-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffa726, #fb8c00);
    border-radius: 3px;
    transition: width 0.5s ease;
  }
  
  /* Boutons CTA améliorés avec dégradés */
  .btn-cta {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 10px 20px;
    font-weight: 600;
    font-size: 0.9rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .btn-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    color: white;
  }
  
  .btn-cta i {
    margin-right: 8px;
  }
  
  /* Table améliorée */
  .table td {
    padding: 12px !important;
    vertical-align: middle;
    font-size: 0.9rem;
  }
  
  .table td strong {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .stats-card {
      padding: 20px;
    }
    
    .stats-card .card-value {
      font-size: 2rem;
    }
    
    .chart-container {
      padding: 15px;
      min-height: 250px;
    }
    
    .card-header, .card-body {
      padding: 15px !important;
    }
  }
  
  /* Animations pour les graphiques */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .chart-container canvas {
    animation: fadeIn 0.5s ease;
  }
</style>
{% endblock %}

{% block body %}
<div class="row">
  <!-- Statistiques principales -->
  <div class="col-lg-3 col-md-6">
    <div class="stats-card">
      <div class="card-icon">
        <i class="tim-icons icon-calendar-60 text-primary"></i>
      </div>
      <h4 class="card-title">{% trans "Total rendez-vous" %}</h4>
      <h2 class="card-value text-primary">{{ total_appointments }}</h2>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="stats-card">
      <div class="card-icon">
        <i class="tim-icons icon-briefcase-24 text-info"></i>
      </div>
      <h4 class="card-title">{% trans "Services" %}</h4>
      <h2 class="card-value text-info">{{ total_services }}</h2>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="stats-card">
      <div class="card-icon">
        <i class="tim-icons icon-single-02 text-success"></i>
      </div>
      <h4 class="card-title">{% trans "Personnel" %}</h4>
      <h2 class="card-value text-success">
        <a href="{% url 'appointment:add_staff_other_info' %}" style="color: inherit; text-decoration: none;">
          {{ total_staff }}
        </a>
      </h2>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="stats-card">
      <div class="card-icon">
        <i class="tim-icons icon-chart-bar-32 text-warning"></i>
      </div>
      <h4 class="card-title">{% trans "Rendez-vous ce mois" %}</h4>
      <h2 class="card-value text-warning">{{ appointments_this_month }}</h2>
    </div>
  </div>
</div>

<div class="row">
  <!-- Graphique des rendez-vous par jour -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title">{% trans "Rendez-vous des 7 derniers jours" %}</h4>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <div id="chartEmptyMessage" class="chart-empty-message" style="display: none;">
            <i class="tim-icons icon-chart-bar-32"></i>
            <p>{% trans "Aucune donnée disponible" %}</p>
            <small>{% trans "Les données apparaîtront ici une fois que des rendez-vous seront créés" %}</small>
          </div>
          <canvas id="appointmentsChart" height="100"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Services populaires -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title">{% trans "Services populaires" %}</h4>
      </div>
      <div class="card-body">
        {% if popular_services %}
        <ul class="popular-services-list">
          {% for service in popular_services %}
          <li>
            <div style="flex: 1;">
              <span class="service-name">{{ service.name }}</span>
              <div class="service-bar">
                <div class="service-bar-fill" style="width: {% if popular_services.0.appointment_count > 0 %}{% widthratio service.appointment_count popular_services.0.appointment_count 100 %}{% else %}0{% endif %}%"></div>
              </div>
            </div>
            <span class="service-count">{{ service.appointment_count }}</span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="text-center" style="padding: 40px 20px; color: rgba(255,255,255,0.5);">
          <i class="tim-icons icon-briefcase-24" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
          <p style="margin: 0;">{% trans "Aucun service pour le moment" %}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Statistiques supplémentaires -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title">{% trans "Statistiques détaillées" %}</h4>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <tbody>
              <tr>
                <td><strong>{% trans "Rendez-vous confirmés (à venir)" %}</strong></td>
                <td class="text-right"><span class="badge badge-success">{{ confirmed_appointments }}</span></td>
              </tr>
              <tr>
                <td><strong>{% trans "Rendez-vous passés" %}</strong></td>
                <td class="text-right"><span class="badge badge-secondary">{{ past_appointments }}</span></td>
              </tr>
              <tr>
                <td><strong>{% trans "Rendez-vous ce mois" %}</strong></td>
                <td class="text-right"><span class="badge badge-info">{{ appointments_this_month }}</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Actions rapides -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h4 class="card-title">{% trans "Actions rapides" %}</h4>
      </div>
      <div class="card-body">
        <div class="d-flex flex-column" style="gap: 12px;">
          <a href="{% url 'appointment:get_user_appointments' %}" class="btn btn-cta">
            <i class="tim-icons icon-calendar-60"></i> {% trans "Voir tous les rendez-vous" %}
          </a>
          <a href="{% url 'appointment:add_service' %}" class="btn btn-info" style="background: linear-gradient(135deg, #17a2b8, #20c997); border: none; box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);">
            <i class="tim-icons icon-simple-add"></i> {% trans "Ajouter un service" %}
          </a>
          <a href="{% url 'appointment:add_staff_other_info' %}" class="btn btn-success" style="background: linear-gradient(135deg, #28a745, #20c997); border: none; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
            <i class="tim-icons icon-single-02"></i> {% trans "Ajouter un membre du personnel" %}
          </a>
          <a href="{% url 'admin:index' %}" class="btn btn-warning" style="background: linear-gradient(135deg, #ffc107, #ff9800); border: none; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);">
            <i class="tim-icons icon-settings-gear-63"></i> {% trans "Administration Django" %}
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block customJS %}
<script>
$(document).ready(function() {
  // Graphique des rendez-vous par jour
  var ctxElement = document.getElementById('appointmentsChart');
  if (!ctxElement) {
    console.warn('Chart element not found');
    return;
  }
  
  var ctx = ctxElement.getContext('2d');
  var appointmentsDataJson = '{{ appointments_by_day|safe }}';
  
  // Parser les données JSON
  var appointmentsData = [];
  try {
    if (appointmentsDataJson && appointmentsDataJson !== '') {
      appointmentsData = JSON.parse(appointmentsDataJson);
    }
  } catch(e) {
    console.error('Error parsing appointments data:', e);
    appointmentsData = [];
  }
  
  // Vérifier si toutes les valeurs sont à zéro
  var hasData = false;
  if (appointmentsData && appointmentsData.length > 0) {
    hasData = appointmentsData.some(function(item) { return item.count > 0; });
  }
  
  // Si pas de données ou toutes à zéro, afficher le message
  if (!appointmentsData || appointmentsData.length === 0 || !hasData) {
    console.warn('No appointment data available');
    $('#appointmentsChart').hide();
    $('#chartEmptyMessage').show();
    return;
  }

  // Vérifier que Chart est disponible
  if (typeof Chart === 'undefined') {
    console.error('Chart.js is not loaded');
    $('#appointmentsChart').hide();
    $('#chartEmptyMessage').show();
    return;
  }

  var chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: appointmentsData.map(function(item) { return item.day || ''; }),
      datasets: [{
        label: '{% trans "Nombre de rendez-vous" %}',
        data: appointmentsData.map(function(item) { return item.count || 0; }),
        borderColor: 'rgba(255, 167, 38, 1)',
        backgroundColor: 'rgba(255, 167, 38, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 5,
        pointHoverRadius: 7,
        pointBackgroundColor: '#ffa726',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: 'rgba(255, 255, 255, 0.8)',
            font: {
              size: 14
            }
          }
        },
        tooltip: {
          enabled: true,
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            color: 'rgba(255, 255, 255, 0.7)',
            stepSize: 1,
            precision: 0
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          }
        },
        x: {
          ticks: {
            color: 'rgba(255, 255, 255, 0.7)'
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          }
        }
      }
    }
  });
});
</script>
{% endblock %}
